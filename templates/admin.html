{% extends "layout.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center">
    <h3>Admin ‚Äî commandes</h3>
    <div>
      <a class="btn btn-outline-secondary" href="/admin/export">Export CSV</a>
    </div>
  </div>

  <h5 class="mt-3">Total g√©n√©ral ventes : {{ '%.2f' % total_general }} ‚Ç¨</h5>

  <h5 class="mt-3">Totaux par produit</h5>
  <table class="table table-sm">
    <thead><tr><th>Produit</th><th>Quantit√© vendue</th><th>Montant total</th></tr></thead>
    <tbody>
    {% for pid, info in totals.items() %}
      <tr><td>{{info.name}}</td><td>{{info.qty}}</td><td>{{ '%.2f' % info.total }} ‚Ç¨</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <form method="POST" action="/admin/clear" target="hidden_iframe" onsubmit="return confirmClear();">
      <button type="submit" class="btn btn-danger mb-3">
          üóëÔ∏è Vider toutes les commandes
      </button>
  </form>

  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
  function confirmClear() {
      if (confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUTES les commandes ?\n\nCette action est irr√©versible !\n\nUne sauvegarde CSV va √™tre t√©l√©charg√©e avant suppression.")) {
          setTimeout(() => {
              location.reload(); // rafra√Æchit l'admin apr√®s le t√©l√©chargement
          }, 1000); // petit d√©lai pour laisser le CSV partir
          return true;
      }
      return false;
  }

  document.addEventListener("DOMContentLoaded", function () {
      const elements = document.querySelectorAll(".utc-date");
      elements.forEach(el => {
          const utcString = el.textContent.trim();
          const date = new Date(utcString + "Z"); // force en UTC
          if (!isNaN(date)) {
              el.textContent = date.toLocaleString(); // convertir dans le fuseau local
          }
      });
  });
  </script>

  <h5 class="mt-3">Historique des commandes</h5>
  <table class="table">
    <thead><tr><th>#</th><th>Date et heure</th><th>Produits</th><th>Total</th></tr></thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td>{{o.id}}</td>
        <td><span class="utc-date">{{o.created_at}}</span></td>
        <td>
          <ul>
          {% for it in o["items"] %}
            <li>{{it.name}} x{{it.qty}}</li>
          {% endfor %}
          </ul>
        </td>
        <td>{{'%.2f' % o.total}} ‚Ç¨</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}
